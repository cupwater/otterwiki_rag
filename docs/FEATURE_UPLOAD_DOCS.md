# 文件上传与解析功能

OtterWiki 现在支持在创建页面时上传文档文件，系统会自动解析文件内容并转换为 Markdown 格式。

## 功能特性

- 📄 支持多种文档格式的自动解析
- 🔄 自动转换为 Markdown 格式
- 📝 解析后的内容作为页面的初始草稿
- 🎯 智能页面名称建议（基于文件名）
- ⚡ 实时文件格式验证

## 支持的文件格式

### 文本文件
- **Markdown** (`.md`) - 直接使用内容
- **纯文本** (`.txt`) - 包装在代码块中
- **CSV** (`.csv`) - 转换为 Markdown 表格
- **JSON** (`.json`) - 格式化为代码块

### 文档文件（需要安装 docling）
- **PDF** (`.pdf`) - 提取文本和结构
- **Word** (`.docx`, `.doc`) - 提取文本和格式
- **Excel** (`.xlsx`, `.xls`) - 提取表格数据
- **PowerPoint** (`.pptx`, `.ppt`) - 提取幻灯片内容

## 使用方法

### 1. 创建页面时上传文件

1. 访问"创建页面"功能
2. 输入页面名称（或让系统自动建议）
3. 点击"选择文件"上传文档
4. 点击"创建并在编辑器中打开"
5. 系统会解析文件并创建包含内容的草稿

### 2. 编辑和保存

- 解析后的内容会自动保存为草稿
- 页面会自动打开编辑器
- 可以预览、修改内容
- 完成编辑后保存页面

### 3. 文件格式示例

#### CSV 文件转换
输入 CSV：
```csv
Name,Age,City
John,30,New York
Jane,25,Los Angeles
```

转换为：
```markdown
| Name | Age | City |
| --- | --- | --- |
| John | 30 | New York |
| Jane | 25 | Los Angeles |
```

#### JSON 文件转换
输入 JSON：
```json
{"name": "John", "age": 30}
```

转换为：
```markdown
\`\`\`json
{
  "name": "John",
  "age": 30
}
\`\`\`
```

## 安装依赖

### 基本功能（文本文件）
无需额外安装，开箱即用。

### 高级功能（PDF、Office 文档）
需要安装 docling 库：

```bash
pip install docling
```

或在 `pyproject.toml` 中添加：
```toml
dependencies = [
    # ... 其他依赖
    "docling>=2.0.0",
]
```

## 错误处理

- **不支持的文件格式**：显示错误信息并提示支持的格式
- **文件解析失败**：显示具体错误信息
- **docling 未安装**：显示安装提示信息
- **文件过大或损坏**：显示相应错误信息

## 技术实现

### 架构
- `document_parser.py` - 核心解析模块
- `views.py` - 处理文件上传的路由
- `create.html` - 上传界面
- `wiki.py` - 页面创建逻辑

### 文件处理流程
1. 用户上传文件
2. 系统验证文件格式
3. 调用相应的解析器
4. 转换为 Markdown 格式
5. 创建草稿并重定向到编辑器

### 安全考虑
- 文件类型白名单验证
- 文件大小限制
- 临时文件自动清理
- 内容安全过滤

## 故障排除

### docling 安装问题
如果无法安装 docling，可以：
1. 使用 conda: `conda install docling`
2. 使用 Docker 环境
3. 仅使用文本文件功能

### 文件解析失败
1. 检查文件是否损坏
2. 确认文件格式是否支持
3. 查看服务器日志获取详细错误信息

### 性能优化
- 大文件建议先压缩
- 复杂 PDF 可能需要更长解析时间
- 建议文件大小控制在 10MB 以内

## 扩展功能

可以通过修改 `document_parser.py` 添加对更多格式的支持：
- 图片文件（OCR）
- 音频文件（转录）
- 视频文件（提取字幕）
- 其他特殊格式

## 贡献

欢迎提交 issue 和 pull request 来改进这个功能！